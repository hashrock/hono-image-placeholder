画像プレースホルダ作成サービス

hono + Cloudflare workers で作ります。

## 機能

- メッシュグラデーション背景画像を作るアプリ
- サーバサイドで描画する
- URL パラメータで各座標や色を渡す
- 一度作った画像はストレージにキャッシュ
  - 外部サービスから URL を直接呼ばれる想定
- /editor で編集 UI
- img の url を書き換えて表示する
- 最終的に URL をコピーできる

## 仕様

### 画像生成
- グリッドサイズ: 6×4
- デフォルト画像サイズ: 1920×1080 (FHD)
- 出力フォーマット: WebP (高圧縮)

### ストレージ
- Cloudflare R2 を使用
- キャッシュキー: URLパラメータのハッシュ値

### エディタUI
- バニラJS で実装
- 最低限の視覚的編集機能

## 開発

```bash
# 依存関係のインストール
pnpm install

# WASM ビルド (初回のみ)
pnpm asbuild

# 開発サーバー起動
pnpm dev
```

開発サーバーが起動したら、`http://localhost:8787/editor` でエディタUIにアクセスできます。

**エディタUI機能：**
- **レンダリングモード切り替え**: JavaScript版とWASM版を選択可能
- **リアルタイムプレビュー**: 全ての設定変更が自動的にプレビューに反映
- **カラープリセット**: 12種類のプリセット（ダーク、ライト、水彩など）
- **グリッド編集**: 6×4グリッドの各ポイントの色と影響度を調整
- **ディスプレイスメント設定**: 周波数と振幅を調整
- **グレイン設定**: テクスチャの強さを調整
- **URL生成**: 設定を含むURLを自動生成・コピー可能

### WASM版 ✅

AssemblyScriptでコンパイルされた高速WASM版が利用可能です！

**実装済み機能：**
- ✅ 完全なグリッド補間ロジック（6×4グリッド対応）
- ✅ スムースノイズによるディスプレイスメントマッピング
- ✅ 高速ハッシュノイズによるグレイン
- ✅ メモリ管理（`__pin`/`__unpin`による安全な割り当て）
- ✅ エンドツーエンドテスト（`pnpm test`）

**パフォーマンス：**
JavaScript版と比較して**約6倍高速**
- WASM版: ~130ms (FHD 1920×1080)
- JavaScript版: ~780ms (同条件)

**ファイルサイズ：**
- WASM バイナリ: わずか **6KB**
- 依存関係: なし（完全自己完結型）

**技術的特徴：**
- **ハッシュベースの滑らかノイズ**: SimplexNoiseの代わりにバイリニア補間＋スムースステップを使用
- **インライン最適化**: `@inline`ディレクティブで関数呼び出しオーバーヘッドを削減
- **StaticArray**: 固定サイズ配列でメモリアロケーションを最小化
- **直接メモリアクセス**: `load<T>`/`store<T>`による高速メモリ操作

**使い方：**
エディターUI (`/editor`) でレンダリングモードを「WASM版（実験的・高速）」に切り替えるだけ！

コードは`assembly/index.ts`および`src/meshGradientWasm.ts`に実装されています。

## デプロイ

### 1. R2バケットの作成

まず、Cloudflare R2バケットを作成します：

```bash
# Cloudflareにログイン
npx wrangler login

# R2バケットを作成
npx wrangler r2 bucket create image-placeholder-cache
```

### 2. デプロイ

```bash
pnpm deploy
```

デプロイが完了すると、Cloudflare Workersにアプリケーションがデプロイされます。
表示されたURLにアクセスして動作を確認してください。

### カスタムドメインの設定

Cloudflareダッシュボードから、Workers & Pagesセクションでカスタムドメインを設定できます。

## トラブルシューティング

### R2有効化エラー

```
Please enable R2 through the Cloudflare Dashboard.
```

このエラーが出た場合：

1. [Cloudflareダッシュボード](https://dash.cloudflare.com/)にログイン
2. 左サイドバーから **R2** を選択
3. **Enable R2** ボタンをクリックして有効化
4. 支払い方法を設定（R2には無料枠があります）
   - 10 GB ストレージ
   - 100万回の書き込み/月
   - 1000万回の読み取り/月
5. 有効化後、再度バケット作成コマンドを実行

### R2なしでデプロイ（開発用）

R2を使わずに一時的にデプロイしたい場合は、`wrangler.jsonc`の`r2_buckets`セクションをコメントアウトし、`src/index.ts`のキャッシュ処理を修正してください。ただし、画像は毎回生成されるため本番環境には推奨しません。
